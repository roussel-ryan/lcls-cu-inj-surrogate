import numpy as np
import h5py
import pandas as pd
import matplotlib.pyplot as plt

def main():
    parse_solenoid_scan_data()

def parse_emittance_data():
    '''read and pasrse data from emittance scans'''

    fname = '2020_summer_cu_inj_emit_data.h5'

    with h5py.File(fname,'r') as f:
        grps = []
        for grp_name in list(f.keys()):
            if 'OTR2' in grp_name:
                grps += [f[grp_name]]
                try:
                    sol_val = f[grp_name]['pvdata'].attrs['SOLN:IN20:121:BDES']
                    print(f'{grp_name} {sol_val}')
                except KeyError:
                    print(f'{grp_name}')


def get_single_solenoid_scan():
    fname = 'measurements/2020_summer_cu_inj_solscan_data.h5'

    with h5py.File(fname,'r') as f:
        grps = []
        for grp_name in list(f.keys()):
            if 'OTR2' in grp_name:
                grps += [f[grp_name]]
                #print(grp_name)


        #create dataframe with relevant data
        data = []
        
        for g in [grps[-1]]:
            #g = grps[-1]
            for name, val in g['beam_data'].items():
                #combine setpoints
                sol_info = dict(val.attrs)
                pvdata = dict(g['pvdata'].attrs)
                pvdata.update(sol_info)

                #add screen data
                n = ['stats_XRMS','stats_YRMS']
                rms_sizes = {ele:val['sample0']['Gaussian'][ele][()] for ele in n}
                
                pvdata.update(rms_sizes)
                             
                data += [pvdata]

            
        df = pd.DataFrame(data)
        #print(df)


        #scan_data = df[['SOLN:IN20:121:BCTRL','stats_XRMS','stats_YRMS']]

        #df.plot(x = 'SOLN:IN20:121:BCTRL',style='+')

    return df

def parse_solenoid_scan_data():
    fname = 'measurements/2020_summer_cu_inj_solscan_data.h5'

    with h5py.File(fname,'r') as f:
        grps = []
        for grp_name in list(f.keys()):
            if 'OTR2' in grp_name:
                grps += [f[grp_name]]
                #print(grp_name)


        #create dataframe with relevant data
        data = []
        
        for g in grps:
            #g = grps[-1]
            for name, val in g['beam_data'].items():
                #combine setpoints
                sol_info = dict(val.attrs)
                pvdata = dict(g['pvdata'].attrs)
                pvdata.update(sol_info)

                #add screen data
                n = ['stats_XRMS','stats_YRMS']
                rms_sizes = {ele:val['sample0']['Gaussian'][ele][()] for ele in n}
                
                pvdata.update(rms_sizes)
                             
                data += [pvdata]

            
        df = pd.DataFrame(data)
        #print(df)


        #scan_data = df[['SOLN:IN20:121:BCTRL','stats_XRMS','stats_YRMS']]

        #df.plot(x = 'SOLN:IN20:121:BCTRL',style='+')

    return df

if __name__ == '__main__':
    main()
    plt.show()
